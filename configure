#!/bin/bash

#StitchUp configuration script
#LEGUP_DIR needs to be set to the root directory of the LegUp tool

if [ "$#" -ne 1 ]; then
    echo "Usage ./configure <LegUp Directory>"
    exit 126
fi

#Get the home directory for the legup installation.
echo "LegUp is installed at $1";
LEGUP_HOME=$1
#For now I will just assume that the LegUp directory looks sane
#Checks should be implemented here in the future though

LLVM_DIR=$LEGUP_HOME/llvm
LLVM_LIB_DIR=$LLVM_DIR/lib/Transforms
STITCH_UP_DIR=$LLVM_LIB_DIR/StitchUp

LLVMStitchUp=$(pwd)/LLVMStitchUp

#Making the StitchUp LLVM library directory and creating a symbolic link to it
if [ ! -L $STITCH_UP_DIR ]; then
    cp -rs $(pwd)/LLVMStitchUp/ $STITCH_UP_DIR
fi

#Include StitchUp to the library makefile lists.
if grep -q "StitchUp" $LLVM_LIB_DIR/Makefile; then
    echo "The StitchUp Library has already been included into the LLVM lib Makefile $LLVM_LIB_DIR/Makefile"
else
    sed -i '/^PARALLEL_DIRS = .*/ s/$/ StitchUp/' $LLVM_LIB_DIR/Makefile
fi

echo "LLVM_DIR=$LLVM_DIR" > Makefile.config
echo "LLVM_LIB_DIR=$LLVM_LIB_DIR" >> Makefile.config
echo "STITCH_UP_DIR=$STITCH_UP_DIR" >>Makefile.config

#Generate the Makfile in the local StitchUp directory
#if grep -q "LEVEL" $LLVMStitchUp/Makefile; then
#	echo "StitchUp library makefile has already been configured"
#else
#	#echo -e "LEVEL=$LLVM_DIR\n$(cat $LLVMStitchUp/Makefile)" > $LLVMStitchUp/Makefile 
#	echo -e "LEVEL=../../.." > $LLVMStitchUp/Makefile
#fi

echo "Reconfiguring the LLVM base"
CURR_DIR=$(pwd)
(cd $LLVM_DIR; ./configure; cd $CURR_DIR;)
echo "Finished configuring the LLVM base"

#Attempting to build the StitchUp pass
(cd $STITCH_UP_DIR; make; cd $CURR_DIR;)


